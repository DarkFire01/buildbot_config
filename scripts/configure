#!/bin/bash
# ReactOS BuildBot Build Scripts
# configure - Set up the environment for building and let CMake generate build files.
#
# Parameter $1 - SVN Revision number of the build
source ../../config.inc

export REVISION_ID=$1

$TIME bash -c "(
	mkdir -p $CCACHE_DIR
	ccache -M $CCACHE_MEMORY
	mkdir -p $ROS_OUTPUT
	cd $ROS_OUTPUT
	mkdir -p reactos

	EXTRA_ARGS=""
	if [ "$REVISION_ID" -lt "$ROS_NO_HOST_TOOLS_REV" ]; then
		mkdir -p host-tools
		cd host-tools
		rm -f CMakeCache.txt
		cmake -G 'Ninja' -DARCH:STRING=$ROS_ARCH $SOURCEDIR
		EXTRA_ARGS="-DREACTOS_BUILD_TOOLS_DIR:PATH=$ROS_OUTPUT/host-tools"
		cd ..
	fi

	cd reactos
	rm -f CMakeCache.txt
	cmake -G 'Ninja' -DENABLE_CCACHE:BOOL=1 -DCMAKE_TOOLCHAIN_FILE:FILEPATH=toolchain-gcc.cmake -DARCH:STRING=$ROS_ARCH $EXTRA_ARGS $SOURCEDIR
)"
